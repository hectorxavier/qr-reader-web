<form id="loginForm" class="mx-auto" style="max-width: 400px;">
    <div class="mb-3">
        <label for="username" class="form-label">Usuario</label>
        <input type="text" class="form-control" name="username" id="username" required>
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input type="password" class="form-control" name="password" id="password" required>
    </div>
    <button type="submit" class="btn btn-primary w-100">Ingresar</button>
</form>

<script>
document.getElementById("loginForm").addEventListener("submit", function(e){
    e.preventDefault(); // Evita que se envíe el formulario automáticamente

    if (!navigator.geolocation) {
        alert("Este navegador no soporta geolocalización.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position){
            // Guardar latitud y longitud en sessionStorage o enviar al backend si quieres
            sessionStorage.setItem("user_lat", position.coords.latitude);
            sessionStorage.setItem("user_lon", position.coords.longitude);

            // Ahora enviamos los datos del login
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            fetch("/login", {
                method: "POST",
                headers: {"Content-Type":"application/x-www-form-urlencoded"},
                body: new URLSearchParams({username, password})
            })
            .then(res => {
                if (res.redirected) {
                    window.location.href = res.url;
                } else {
                    res.text().then(txt => alert(txt));
                }
            })
            .catch(err => alert("Error de conexión: " + err));
        },
        function(error){
            alert("No se pudo obtener la ubicación: " + error.message);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
});
</script>
